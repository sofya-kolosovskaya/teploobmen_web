@using HeatExchangeApp.Models
@model CalculationInput

@{
    ViewData["Title"] = "Расчет теплообмена";
    Layout = null;
}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        body {
            padding-top: 70px;
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background-color: #0d6efd;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .navbar-brand {
            color: white !important;
            font-weight: 700;
        }

        .container {
            max-width: 1200px;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,.1);
            margin-bottom: 20px;
        }

        .card-header {
            background-color: #0d6efd;
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
            padding: 15px 20px;
        }

        .form-control {
            border-radius: 6px;
            padding: 10px 15px;
            border: 1px solid #ced4da;
            transition: all 0.3s;
        }

            .form-control:focus {
                border-color: #0d6efd;
                box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            }

        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 8px;
        }

        .btn {
            border-radius: 6px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #0d6efd;
            border: none;
        }

            .btn-primary:hover {
                background-color: #0b5ed7;
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(13, 110, 253, 0.25);
            }

        .btn-outline-secondary:hover {
            transform: translateY(-1px);
        }

        .form-text {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 5px;
        }

        /* Стили для валидации */
        .is-invalid {
            border-color: #dc3545 !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }

            .is-invalid:focus {
                box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
            }

        /* Убирает стандартные сообщения браузера */
        input:invalid {
            box-shadow: none;
        }

        input:required:invalid {
            box-shadow: none;
        }

        .form-control:invalid {
            border-color: #ced4da !important;
        }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/Calculation">
                <i class="bi bi-thermometer-half"></i> HeatExchange
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/Calculation">
                    <i class="bi bi-calculator"></i> Расчет
                </a>
                <a class="nav-link" href="/History">
                    <i class="bi bi-clock-history"></i> История
                </a>
                @if (Context.Session.GetString("Username") != null)
                {
                    <span class="nav-link">
                        <i class="bi bi-person-circle"></i> @Context.Session.GetString("Username")
                    </span>
                }
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="bi bi-calculator text-primary"></i> Расчет теплообмена
        </h1>

        <!-- Форма -->
        <form method="post" action="/Calculation/Calculate" novalidate>
            @Html.AntiForgeryToken()

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-gear"></i> Основные параметры</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Название расчета:</label>
                                <input type="text" name="calcName" class="form-control"
                                       value="Расчет @DateTime.Now.ToString("dd.MM.yyyy HH:mm")">
                                <div class="form-text">Имя для сохранения в истории</div>
                            </div>

                            <!-- Обновленные поля с границами и подсказками -->
                            <div class="mb-3">
                                <label class="form-label">Высота слоя H₀, м:</label>
                                <input type="number" step="0.1" name="H0" class="form-control" value="5.0"
                                       min="0.1" max="50" required
                                       oninput="validateNumber(this, 0.1, 50, 'Высота слоя должна быть от 0.1 до 50 м')">
                                <div class="form-text">Допустимые значения: от 0.1 до 50 метров</div>
                                <div class="invalid-feedback" id="H0-error"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Температура газа t', °C:</label>
                                <input type="number" name="TPrime" class="form-control" value="700"
                                       min="-273" max="3000" required
                                       oninput="validateNumber(this, -273, 3000, 'Температура должна быть от -273 до 3000°C')">
                                <div class="form-text">Допустимые значения: от -273 до 3000°C</div>
                                <div class="invalid-feedback" id="TPrime-error"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Температура материала T', °C:</label>
                                <input type="number" name="TDoublePrime" class="form-control" value="20"
                                       min="-273" max="2000" required
                                       oninput="validateNumber(this, -273, 2000, 'Температура должна быть от -273 до 2000°C')">
                                <div class="form-text">Допустимые значения: от -273 до 2000°C</div>
                                <div class="invalid-feedback" id="TDoublePrime-error"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Скорость газа wг, м/с:</label>
                                <input type="number" step="0.01" name="Wg" class="form-control" value="0.78"
                                       min="0.01" max="20" required
                                       oninput="validateNumber(this, 0.01, 20, 'Скорость должна быть от 0.01 до 20 м/с')">
                                <div class="form-text">Допустимые значения: от 0.01 до 20 м/с</div>
                                <div class="invalid-feedback" id="Wg-error"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Теплоемкость газа Cг, кДж/(кг·К):</label>
                                <input type="number" step="0.01" name="Cg" class="form-control" value="1.32"
                                       min="0.1" max="5" required
                                       oninput="validateNumber(this, 0.1, 5, 'Теплоемкость должна быть от 0.1 до 5 кДж/(кг·К)')">
                                <div class="form-text">Допустимые значения: от 0.1 до 5 кДж/(кг·К)</div>
                                <div class="invalid-feedback" id="Cg-error"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Расход материала Gм, кг/с:</label>
                                <input type="number" step="0.01" name="Gm" class="form-control" value="1.72"
                                       min="0.01" max="50" required
                                       oninput="validateNumber(this, 0.01, 50, 'Расход должен быть от 0.01 до 50 кг/с')">
                                <div class="form-text">Допустимые значения: от 0.01 до 50 кг/с</div>
                                <div class="invalid-feedback" id="Gm-error"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Теплоемкость материала Cм, кДж/(кг·К):</label>
                                <input type="number" step="0.01" name="Cm" class="form-control" value="1.49"
                                       min="0.1" max="5" required
                                       oninput="validateNumber(this, 0.1, 5, 'Теплоемкость должна быть от 0.1 до 5 кДж/(кг·К)')">
                                <div class="form-text">Допустимые значения: от 0.1 до 5 кДж/(кг·К)</div>
                                <div class="invalid-feedback" id="Cm-error"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Коэффициент теплоотдачи αv, Вт/(м³·К):</label>
                                <input type="number" name="Av" class="form-control" value="2460"
                                       min="10" max="20000" required
                                       oninput="validateNumber(this, 10, 20000, 'Коэффициент должен быть от 10 до 20000 Вт/(м³·К)')">
                                <div class="form-text">Допустимые значения: от 10 до 20000 Вт/(м³·К)</div>
                                <div class="invalid-feedback" id="Av-error"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Диаметр аппарата D, м:</label>
                                <input type="number" step="0.1" name="D" class="form-control" value="2.2"
                                       min="0.1" max="20" required
                                       oninput="validateNumber(this, 0.1, 20, 'Диаметр должен быть от 0.1 до 20 м')">
                                <div class="form-text">Допустимые значения: от 0.1 до 20 метров</div>
                                <div class="invalid-feedback" id="D-error"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Количество точек расчета:</label>
                                <input type="number" name="PointsCount" class="form-control" value="11"
                                       min="2" max="200" required
                                       oninput="validateNumber(this, 2, 200, 'Количество точек должно быть от 2 до 200')">
                                <div class="form-text">Допустимые значения: от 2 до 200 точек</div>
                                <div class="invalid-feedback" id="PointsCount-error"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Кнопки действий -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-calculator"></i> Рассчитать
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg" id="resetBtn">
                            <i class="bi bi-arrow-clockwise"></i> Сбросить
                        </button>
                        <a href="/History" class="btn btn-outline-primary btn-lg ms-auto">
                            <i class="bi bi-clock-history"></i> История расчетов
                        </a>
                    </div>
                </div>
            </div>
        </form>

        <!-- Пример значений -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Пример типовых значений</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Параметр</th>
                                <th>Обозначение</th>
                                <th>Типовое значение</th>
                                <th>Единицы</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Высота слоя</td>
                                <td>H₀</td>
                                <td>5.0</td>
                                <td>м</td>
                            </tr>
                            <tr>
                                <td>Температура газа на входе</td>
                                <td>t'</td>
                                <td>700</td>
                                <td>°C</td>
                            </tr>
                            <tr>
                                <td>Температура материала на входе</td>
                                <td>T'</td>
                                <td>20</td>
                                <td>°C</td>
                            </tr>
                            <tr>
                                <td>Скорость газа</td>
                                <td>wг</td>
                                <td>0.78</td>
                                <td>м/с</td>
                            </tr>
                            <tr>
                                <td>Теплоемкость газа</td>
                                <td>Cг</td>
                                <td>1.32</td>
                                <td>кДж/(кг·К)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="~/js/validation.js"></script>

    <!-- JavaScript -->
    <script>
        // Обработка кнопки "Сбросить"
        document.getElementById('resetBtn').addEventListener('click', function(e) {
            e.preventDefault();

            // Значения по умолчанию
            const defaultValues = {
                'calcName': 'Расчет ' + new Date().toLocaleDateString('ru-RU'),
                'H0': '5.0',
                'TPrime': '700',
                'TDoublePrime': '20',
                'Wg': '0.78',
                'Cg': '1.32',
                'Gm': '1.72',
                'Cm': '1.49',
                'Av': '2460',
                'D': '2.2',
                'PointsCount': '11'
            };

            // Устанавливаем значения
            for (const [name, value] of Object.entries(defaultValues)) {
                const input = document.querySelector(`[name="${name}"]`);
                if (input) {
                    input.value = value;
                }
            }

            // Показываем сообщение
            showAlert('Форма сброшена к значениям по умолчанию!', 'success');
        });

        // Функция показа уведомлений
        function showAlert(message, type = 'info') {
            // Создаем элемент уведомления
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // Добавляем уведомление перед формой
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);

            // Автоматически скрываем через 3 секунды
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    const bsAlert = new bootstrap.Alert(alertDiv);
                    bsAlert.close();
                }
            }, 3000);
        }

        // Валидация формы при отправке
        document.querySelector('form').addEventListener('submit', function(e) {
            let isValid = true;
            const errors = [];

            // Проверяем все обязательные поля
            this.querySelectorAll('input[required]').forEach(input => {
                if (!input.value.trim()) {
                    errors.push(`Заполните поле: ${input.previousElementSibling?.textContent || input.name}`);
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');

                    // Проверка числовых значений
                    if (input.type === 'number') {
                        const value = parseFloat(input.value);
                        const min = parseFloat(input.min);
                        const max = parseFloat(input.max);

                        if (!isNaN(value)) {
                            if (!isNaN(min) && value < min) {
                                errors.push(`${input.previousElementSibling?.textContent || input.name} не может быть меньше ${min}`);
                                input.classList.add('is-invalid');
                                isValid = false;
                            }

                            if (!isNaN(max) && value > max) {
                                errors.push(`${input.previousElementSibling?.textContent || input.name} не может быть больше ${max}`);
                                input.classList.add('is-invalid');
                                isValid = false;
                            }
                        }
                    }
                }
            });

            if (!isValid) {
                e.preventDefault();

                // Показываем ошибки
                const errorHtml = errors.map(msg => `<li>${msg}</li>`).join('');
                showAlert(`
                    <strong>Исправьте следующие ошибки:</strong>
                    <ul class="mb-0">${errorHtml}</ul>
                `, 'danger');

                // Фокус на первое ошибочное поле
                const firstInvalid = this.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.focus();
                }
            }
        });

        // Автоматическая замена запятой на точку
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('blur', function() {
                let value = this.value;
                if (value && value.includes(',')) {
                    this.value = value.replace(',', '.');
                }
            });
        });

        // Подсказки при наведении
        document.addEventListener('DOMContentLoaded', function() {
            const tooltips = {
                'H0': 'Высота слоя материала',
                'TPrime': 'Температура газа на входе',
                'TDoublePrime': 'Температура материала на входе',
                'Wg': 'Скорость движения газа',
                'Cg': 'Теплоемкость газа',
                'Gm': 'Расход материала',
                'Cm': 'Теплоемкость материала',
                'Av': 'Коэффициент теплоотдачи',
                'D': 'Диаметр аппарата',
                'PointsCount': 'Количество точек для расчета'
            };

            // Добавляем tooltips
            Object.keys(tooltips).forEach(name => {
                const input = document.querySelector(`[name="${name}"]`);
                if (input) {
                    input.setAttribute('data-bs-toggle', 'tooltip');
                    input.setAttribute('data-bs-placement', 'top');
                    input.setAttribute('data-bs-title', tooltips[name]);
                    input.setAttribute('title', tooltips[name]);
                }
            });

            // Инициализация tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(function(tooltipTriggerEl) {
                new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Автофокус на первом поле
            document.querySelector('form').querySelector('input:not([type="hidden"])').focus();
        });
    </script>
</body>
</html>